<html>
<head>
<title>GemDrag</title>
</head>
<body>
<script type="text/javascript" src="phaser.js"></script>
<script type="text/javascript" src="main.js"></script>
<script>


var untested_gems = [
  {'x':0,'y':0,'c':0},//1a
  {'x':0,'y':1,'c':0},//1b
  {'x':0,'y':2,'c':0},//1c
  {'x':0,'y':3,'c':0},//1d & 2a
  {'x':0,'y':4,'c':3},
  {'x':1,'y':0,'c':3},
  {'x':1,'y':1,'c':2},
  {'x':1,'y':2,'c':2},
  {'x':1,'y':3,'c':0},//2b
  {'x':1,'y':4,'c':3},
  {'x':2,'y':0,'c':3},
  {'x':2,'y':1,'c':0},//3c & 4a
  {'x':2,'y':2,'c':0},//3b
  {'x':2,'y':3,'c':0},//2c & 3a
  {'x':2,'y':4,'c':3},
  {'x':3,'y':0,'c':2},
  {'x':3,'y':1,'c':0},//4b
  {'x':3,'y':2,'c':2},
  {'x':3,'y':3,'c':0},//2d
  {'x':3,'y':4,'c':1},
  {'x':4,'y':0,'c':2},
  {'x':4,'y':1,'c':0},//4c
  {'x':4,'y':2,'c':1},
  {'x':4,'y':3,'c':2},
  {'x':4,'y':4,'c':2}
]

var _gems_in_run = [];
var _gems_in_entire_path = [];
var _p_runs = [];
var all_paths = {};
var BOARD_COLS = 4;
var BOARD_ROWS = 4;
var current_gem_id = 0;
var _positions_of_perpendicular_runs = [];
var tested_gems = {};

for(var gem_id=0;gem_id<untested_gems.length;gem_id++){
  var directions = visibleRuns(untested_gems[gem_id]);
  for(var n=0;n<directions.length;n++){
    _g = untested_gems[gem_id];
    if(tested_gems[_g.x+"-"+_g.y] === undefined){
      path = follow(untested_gems[gem_id], directions[n]);
      color = untested_gems[gem_id].c;
      all_paths[color] = (all_paths[color]||[]).concat(path);
    }
  };
};


// return an array of gems
// recurse on found run-starts
function follow(gem, direction){
  console.count('found');
  var new_gem = oneGemOver(gem,direction);
  tested_gems[gem.x+"-"+gem.y]=true;
  _gems_in_entire_path.push(gem);
  if(!find_perpendicular_starts(gem, direction)){ //check for other run-starts
  };
  if(new_gem !== undefined && gem.c === new_gem.c){ //  next gem has same color
    return follow(new_gem, direction); // recurse
  }else{// end of run.
    // recurse on any found _perpendicular runs.
    while(_positions_of_perpendicular_runs.length>0){
      var obj = _positions_of_perpendicular_runs.shift();
      var directions = obj.directions;
      for(var _d=0;_d<directions.length;_i++){
        var new_new_gem = oneGemOver(obj.gem,directions[_d]);
        return follow(new_new_gem, directions[_d]);
      }
    };
    return _gems_in_entire_path;
  }
}

function find_perpendicular_starts(gem, direction){
  var _found_directions = [];
  switch (direction){
    case 'up':
    case 'down':
      var left = countRun(gem,'left');
      var right = countRun(gem,'right');
      if(left>0){ _found_directions.push('left') }
      if(right>0){ _found_directions.push('right') }
      break;
    case 'left':
    case 'right':
      var up = countRun(gem,'up');
      var down = countRun(gem,'down');
      if(up>0){ _found_directions.push('up') }
      if(down>0){ _found_directions.push('down') }
      break;
  }

  if(_found_directions.length>0){
    return _positions_of_perpendicular_runs.push({ 'gem':gem, 'directions': _found_directions });
  }
  return false;
}

function countRun(gem, direction){
  var count = 0;
  switch(direction) {
    case 'up':
      count = countSameColorGems(gem, 0, -1);
      break;
    case 'right':
      count = countSameColorGems(gem, 1, 0);
      break;
    case 'down':
      count = countSameColorGems(gem, 0, 1);
      break;
    case 'left':
      count = countSameColorGems(gem, -1, 0);
    break;
  }
  return count;
}

function oneGemOver(gem, direction){
  switch(direction) {
    case 'up':
      new_x = gem.x;
      new_y = gem.y-1;
      break;
    case 'right':
      new_x = gem.x+1;
      new_y = gem.y;
      break;
    case 'down':
      new_x = gem.x;
      new_y = gem.y+1;
      break;
    case 'left':
      new_x = gem.x-1;
      new_y = gem.y;
    break;
  }
  return findGem(new_x,new_y);
}


function visibleRuns(gem){
    directions = [];
    var countRight = countSameColorGems(gem, 1, 0);
    var countLeft = countSameColorGems(gem, -1, 0);
    var countUp = countSameColorGems(gem, 0, -1);
    var countDown = countSameColorGems(gem, 0, 1);
    if(countUp>1){directions.push('up');}
    if(countDown>1){directions.push('down');}
    if(countLeft>1){directions.push('left');}
    if(countRight>1){directions.push('right');}
    return directions;
}


function findGem(x,y){
  for(var i=0;i<untested_gems.length;i++){
    if(untested_gems[i].x === x && untested_gems[i].y === y){
      return untested_gems[i];
    }
  }
  return false;
}

</script>

</body>
</body>
</html>
